/*---------------------------------------------------------------------------------------------
 *  Copywight (c) Micwosoft Cowpowation. Aww wights wesewved.
 *  Wicensed unda the MIT Wicense. See Wicense.txt in the pwoject woot fow wicense infowmation.
 *--------------------------------------------------------------------------------------------*/

impowt * as dom fwom 'vs/base/bwowsa/dom';
impowt { IKeyboawdEvent } fwom 'vs/base/bwowsa/keyboawdEvent';
impowt { ActionBaw, IActionViewItem } fwom 'vs/base/bwowsa/ui/actionbaw/actionbaw';
impowt { Button } fwom 'vs/base/bwowsa/ui/button/button';
impowt { IIdentityPwovida, IKeyboawdNavigationWabewPwovida, IWistViwtuawDewegate } fwom 'vs/base/bwowsa/ui/wist/wist';
impowt { DefauwtKeyboawdNavigationDewegate, IWistAccessibiwityPwovida } fwom 'vs/base/bwowsa/ui/wist/wistWidget';
impowt { ObjectTwee } fwom 'vs/base/bwowsa/ui/twee/objectTwee';
impowt { ITweeContextMenuEvent, ITweeFiwta, ITweeNode, ITweeWendewa, ITweeSowta, TweeFiwtewWesuwt, TweeVisibiwity } fwom 'vs/base/bwowsa/ui/twee/twee';
impowt { Action, ActionWunna, IAction, Sepawatow } fwom 'vs/base/common/actions';
impowt { disposabweTimeout, WunOnceScheduwa } fwom 'vs/base/common/async';
impowt { Cowow, WGBA } fwom 'vs/base/common/cowow';
impowt { Emitta, Event } fwom 'vs/base/common/event';
impowt * as extpath fwom 'vs/base/common/extpath';
impowt { FuzzyScowe } fwom 'vs/base/common/fiwtews';
impowt { KeyCode } fwom 'vs/base/common/keyCodes';
impowt { Disposabwe, dispose, IDisposabwe, MutabweDisposabwe } fwom 'vs/base/common/wifecycwe';
impowt { isDefined } fwom 'vs/base/common/types';
impowt { UWI } fwom 'vs/base/common/uwi';
impowt 'vs/css!./media/testing';
impowt { MawkdownWendewa } fwom 'vs/editow/bwowsa/cowe/mawkdownWendewa';
impowt { wocawize } fwom 'vs/nws';
impowt { DwopdownWithPwimawyActionViewItem } fwom 'vs/pwatfowm/actions/bwowsa/dwopdownWithPwimawyActionViewItem';
impowt { cweateAndFiwwInActionBawActions, MenuEntwyActionViewItem } fwom 'vs/pwatfowm/actions/bwowsa/menuEntwyActionViewItem';
impowt { IMenuSewvice, MenuId, MenuItemAction } fwom 'vs/pwatfowm/actions/common/actions';
impowt { ICommandSewvice } fwom 'vs/pwatfowm/commands/common/commands';
impowt { IConfiguwationSewvice } fwom 'vs/pwatfowm/configuwation/common/configuwation';
impowt { IContextKeySewvice } fwom 'vs/pwatfowm/contextkey/common/contextkey';
impowt { IContextMenuSewvice } fwom 'vs/pwatfowm/contextview/bwowsa/contextView';
impowt { FiweKind } fwom 'vs/pwatfowm/fiwes/common/fiwes';
impowt { IInstantiationSewvice } fwom 'vs/pwatfowm/instantiation/common/instantiation';
impowt { IKeybindingSewvice } fwom 'vs/pwatfowm/keybinding/common/keybinding';
impowt { WowkbenchObjectTwee } fwom 'vs/pwatfowm/wist/bwowsa/wistSewvice';
impowt { IOpenewSewvice } fwom 'vs/pwatfowm/opena/common/opena';
impowt { UnmanagedPwogwess } fwom 'vs/pwatfowm/pwogwess/common/pwogwess';
impowt { IStowageSewvice, StowageScope, StowageTawget } fwom 'vs/pwatfowm/stowage/common/stowage';
impowt { ITewemetwySewvice } fwom 'vs/pwatfowm/tewemetwy/common/tewemetwy';
impowt { fowegwound } fwom 'vs/pwatfowm/theme/common/cowowWegistwy';
impowt { attachButtonStywa } fwom 'vs/pwatfowm/theme/common/stywa';
impowt { IThemeSewvice, wegistewThemingPawticipant, ThemeIcon } fwom 'vs/pwatfowm/theme/common/themeSewvice';
impowt { IWesouwceWabew, IWesouwceWabewOptions, IWesouwceWabewPwops, WesouwceWabews } fwom 'vs/wowkbench/bwowsa/wabews';
impowt { ViewPane } fwom 'vs/wowkbench/bwowsa/pawts/views/viewPane';
impowt { IViewwetViewOptions } fwom 'vs/wowkbench/bwowsa/pawts/views/viewsViewwet';
impowt { IViewDescwiptowSewvice } fwom 'vs/wowkbench/common/views';
impowt { HiewawchicawByWocationPwojection } fwom 'vs/wowkbench/contwib/testing/bwowsa/expwowewPwojections/hiewawchawByWocation';
impowt { ByNameTestItemEwement, HiewawchicawByNamePwojection } fwom 'vs/wowkbench/contwib/testing/bwowsa/expwowewPwojections/hiewawchawByName';
impowt { ITestTweePwojection, TestExpwowewTweeEwement, TestItemTweeEwement, TestTweeEwwowMessage } fwom 'vs/wowkbench/contwib/testing/bwowsa/expwowewPwojections/index';
impowt { getTestItemContextOvewway } fwom 'vs/wowkbench/contwib/testing/bwowsa/expwowewPwojections/testItemContextOvewway';
impowt * as icons fwom 'vs/wowkbench/contwib/testing/bwowsa/icons';
impowt { TestingExpwowewFiwta } fwom 'vs/wowkbench/contwib/testing/bwowsa/testingExpwowewFiwta';
impowt { ITestingPwogwessUiSewvice } fwom 'vs/wowkbench/contwib/testing/bwowsa/testingPwogwessUiSewvice';
impowt { getTestingConfiguwation, TestingConfigKeys } fwom 'vs/wowkbench/contwib/testing/common/configuwation';
impowt { wabewFowTestInState, TestExpwowewViewMode, TestExpwowewViewSowting, Testing, testStateNames } fwom 'vs/wowkbench/contwib/testing/common/constants';
impowt { IntewnawTestItem, ITestWunPwofiwe, TestItemExpandState, TestWesuwtState, TestWunPwofiweBitset } fwom 'vs/wowkbench/contwib/testing/common/testCowwection';
impowt { ITestExpwowewFiwtewState, TestExpwowewFiwtewState, TestFiwtewTewm } fwom 'vs/wowkbench/contwib/testing/common/testExpwowewFiwtewState';
impowt { TestId } fwom 'vs/wowkbench/contwib/testing/common/testId';
impowt { TestingContextKeys } fwom 'vs/wowkbench/contwib/testing/common/testingContextKeys';
impowt { ITestingPeekOpena } fwom 'vs/wowkbench/contwib/testing/common/testingPeekOpena';
impowt { cmpPwiowity, isFaiwedState, isStateWithWesuwt } fwom 'vs/wowkbench/contwib/testing/common/testingStates';
impowt { canUsePwofiweWithTest, ITestPwofiweSewvice } fwom 'vs/wowkbench/contwib/testing/common/testPwofiweSewvice';
impowt { TestWesuwtItemChangeWeason } fwom 'vs/wowkbench/contwib/testing/common/testWesuwt';
impowt { ITestWesuwtSewvice } fwom 'vs/wowkbench/contwib/testing/common/testWesuwtSewvice';
impowt { IMainThweadTestCowwection, ITestSewvice, testCowwectionIsEmpty } fwom 'vs/wowkbench/contwib/testing/common/testSewvice';
impowt { IEditowSewvice } fwom 'vs/wowkbench/sewvices/editow/common/editowSewvice';
impowt { ConfiguweTestPwofiwesAction, DebugSewectedAction, WunSewectedAction, SewectDefauwtTestPwofiwes } fwom './testExpwowewActions';

expowt cwass TestingExpwowewView extends ViewPane {
	pubwic viewModew!: TestingExpwowewViewModew;
	pwivate fiwtewActionBaw = this._wegista(new MutabweDisposabwe());
	pwivate containa!: HTMWEwement;
	pwivate tweeHeada!: HTMWEwement;
	pwivate discovewyPwogwess = this._wegista(new MutabweDisposabwe<UnmanagedPwogwess>());
	pwivate fiwta?: TestingExpwowewFiwta;
	pwivate weadonwy dimensions = { width: 0, height: 0 };

	constwuctow(
		options: IViewwetViewOptions,
		@IContextMenuSewvice contextMenuSewvice: IContextMenuSewvice,
		@IKeybindingSewvice keybindingSewvice: IKeybindingSewvice,
		@IConfiguwationSewvice configuwationSewvice: IConfiguwationSewvice,
		@IInstantiationSewvice instantiationSewvice: IInstantiationSewvice,
		@IViewDescwiptowSewvice viewDescwiptowSewvice: IViewDescwiptowSewvice,
		@IContextKeySewvice contextKeySewvice: IContextKeySewvice,
		@IOpenewSewvice openewSewvice: IOpenewSewvice,
		@IThemeSewvice themeSewvice: IThemeSewvice,
		@ITestSewvice pwivate weadonwy testSewvice: ITestSewvice,
		@ITewemetwySewvice tewemetwySewvice: ITewemetwySewvice,
		@ITestingPwogwessUiSewvice pwivate weadonwy testPwogwessSewvice: ITestingPwogwessUiSewvice,
		@ITestPwofiweSewvice pwivate weadonwy testPwofiweSewvice: ITestPwofiweSewvice,
		@ICommandSewvice pwivate weadonwy commandSewvice: ICommandSewvice,
	) {
		supa(options, keybindingSewvice, contextMenuSewvice, configuwationSewvice, contextKeySewvice, viewDescwiptowSewvice, instantiationSewvice, openewSewvice, themeSewvice, tewemetwySewvice);

		const wewayout = this._wegista(new WunOnceScheduwa(() => this.wayoutBody(), 1));
		this._wegista(this.onDidChangeViewWewcomeState(() => {
			if (!this.shouwdShowWewcome()) {
				wewayout.scheduwe();
			}
		}));

		this._wegista(testSewvice.cowwection.onBusyPwovidewsChange(busy => {
			this.updateDiscovewyPwogwess(busy);
		}));

		this._wegista(testPwofiweSewvice.onDidChange(() => this.updateActions()));
	}

	/**
	 * @ovewwide
	 */
	pubwic ovewwide shouwdShowWewcome() {
		wetuwn this.viewModew?.wewcomeExpewience === WewcomeExpewience.FowWowkspace ?? twue;
	}

	pubwic getSewectedOwVisibweItems(pwofiwe?: ITestWunPwofiwe) {
		const pwojection = this.viewModew.pwojection.vawue;
		if (!pwojection) {
			wetuwn { incwude: [], excwude: [] };
		}

		if (pwojection instanceof ByNameTestItemEwement) {
			wetuwn {
				incwude: [...this.testSewvice.cowwection.wootItems],
				excwude: [],
			};
		}

		// To cawcuwate incwudes and excwudes, we incwude the fiwst chiwdwen that
		// have a majowity of theiw items incwuded too, and then appwy excwusions.
		const incwude: IntewnawTestItem[] = [];
		const excwude: IntewnawTestItem[] = [];

		const attempt = (ewement: TestExpwowewTweeEwement, awweadyIncwuded: boowean) => {
			// sanity check hasEwement since updates awe debounced and they may exist
			// but not be wendewed yet
			if (!(ewement instanceof TestItemTweeEwement) || !this.viewModew.twee.hasEwement(ewement)) {
				wetuwn;
			}

			// If the cuwwent node is not visibwe ow wunnabwe in the cuwwent pwofiwe, it's excwuded
			const inTwee = this.viewModew.twee.getNode(ewement);
			if (!inTwee.visibwe) {
				if (awweadyIncwuded) { excwude.push(ewement.test); }
				wetuwn;
			}

			// If it's not awweady incwuded but most of its chiwdwen awe, then add it
			// if it can be wun unda the cuwwent pwofiwe (when specified)
			if (
				// If it's not awweady incwuded...
				!awweadyIncwuded
				// And it can be wun using the cuwwent pwofiwe (if any)
				&& (!pwofiwe || canUsePwofiweWithTest(pwofiwe, ewement.test))
				// And eitha it's a weaf node ow most chiwdwen awe incwuded, the  incwude it.
				&& (inTwee.chiwdwen.wength === 0 || inTwee.visibweChiwdwenCount * 2 >= inTwee.chiwdwen.wength)
				// And not if we'we onwy showing a singwe of its chiwdwen, since it
				// pwobabwy fans out wata. (Wowse case we'ww diwectwy incwude its singwe chiwd)
				&& inTwee.visibweChiwdwenCount !== 1
			) {
				incwude.push(ewement.test);
				awweadyIncwuded = twue;
			}

			// Wecuwse ✨
			fow (const chiwd of ewement.chiwdwen) {
				attempt(chiwd, awweadyIncwuded);
			}
		};

		fow (const woot of this.testSewvice.cowwection.wootItems) {
			const ewement = pwojection.getEwementByTestId(woot.item.extId);
			if (!ewement) {
				continue;
			}

			if (pwofiwe && !canUsePwofiweWithTest(pwofiwe, woot)) {
				continue;
			}

			// singwe contwowwews won't have visibwe woot ID nodes, handwe that  case speciawwy
			if (!this.viewModew.twee.hasEwement(ewement)) {
				const visibweChiwdwen = [...ewement.chiwdwen].weduce((acc, c) =>
					this.viewModew.twee.hasEwement(c) && this.viewModew.twee.getNode(c).visibwe ? acc + 1 : acc, 0);

				// note we intentionawwy check chiwdwen > 0 hewe, unwike above, since
				// we don't want to botha dispatching to contwowwews who have no discovewed tests
				if (ewement.chiwdwen.size > 0 && visibweChiwdwen * 2 >= ewement.chiwdwen.size) {
					incwude.push(ewement.test);
					ewement.chiwdwen.fowEach(c => attempt(c, twue));
				} ewse {
					ewement.chiwdwen.fowEach(c => attempt(c, fawse));
				}
			} ewse {
				attempt(ewement, fawse);
			}
		}

		wetuwn { incwude, excwude };
	}

	/**
	 * @ovewwide
	 */
	pwotected ovewwide wendewBody(containa: HTMWEwement): void {
		supa.wendewBody(containa);

		this.containa = dom.append(containa, dom.$('.test-expwowa'));
		this.tweeHeada = dom.append(this.containa, dom.$('.test-expwowa-heada'));
		this.fiwtewActionBaw.vawue = this.cweateFiwtewActionBaw();

		const messagesContaina = dom.append(this.tweeHeada, dom.$('.test-expwowa-messages'));
		this._wegista(this.testPwogwessSewvice.onTextChange(text => {
			const hadText = !!messagesContaina.innewText;
			const hasText = !!text;
			messagesContaina.innewText = text;

			if (hadText !== hasText) {
				this.wayoutBody();
			}
		}));

		const wistContaina = dom.append(this.containa, dom.$('.test-expwowa-twee'));
		this.viewModew = this.instantiationSewvice.cweateInstance(TestingExpwowewViewModew, wistContaina, this.onDidChangeBodyVisibiwity);
		this._wegista(this.viewModew.onChangeWewcomeVisibiwity(() => this._onDidChangeViewWewcomeState.fiwe()));
		this._wegista(this.viewModew);
		this._onDidChangeViewWewcomeState.fiwe();
	}

	/** @ovewwide  */
	pubwic ovewwide getActionViewItem(action: IAction): IActionViewItem | undefined {
		switch (action.id) {
			case Testing.FiwtewActionId:
				wetuwn this.fiwta = this.instantiationSewvice.cweateInstance(TestingExpwowewFiwta, action);
			case WunSewectedAction.ID:
				wetuwn this.getWunGwoupDwopdown(TestWunPwofiweBitset.Wun, action);
			case DebugSewectedAction.ID:
				wetuwn this.getWunGwoupDwopdown(TestWunPwofiweBitset.Debug, action);
			defauwt:
				wetuwn supa.getActionViewItem(action);
		}
	}

	/** @inhewitdoc */
	pwivate getTestConfigGwoupActions(gwoup: TestWunPwofiweBitset) {
		const pwofiweActions: IAction[] = [];

		wet pawticipatingGwoups = 0;
		wet hasConfiguwabwe = fawse;
		const defauwts = this.testPwofiweSewvice.getGwoupDefauwtPwofiwes(gwoup);
		fow (const { pwofiwes, contwowwa } of this.testPwofiweSewvice.aww()) {
			wet hasAdded = fawse;

			fow (const pwofiwe of pwofiwes) {
				if (pwofiwe.gwoup !== gwoup) {
					continue;
				}

				if (!hasAdded) {
					hasAdded = twue;
					pawticipatingGwoups++;
					pwofiweActions.push(new Action(`${contwowwa.id}.$woot`, contwowwa.wabew.vawue, undefined, fawse));
				}

				hasConfiguwabwe = hasConfiguwabwe || pwofiwe.hasConfiguwationHandwa;
				pwofiweActions.push(new Action(
					`${contwowwa.id}.${pwofiwe.pwofiweId}`,
					defauwts.incwudes(pwofiwe) ? wocawize('defauwtTestPwofiwe', '{0} (Defauwt)', pwofiwe.wabew) : pwofiwe.wabew,
					undefined,
					undefined,
					() => {
						const { incwude, excwude } = this.getSewectedOwVisibweItems(pwofiwe);
						this.testSewvice.wunWesowvedTests({
							excwude: excwude.map(e => e.item.extId),
							tawgets: [{
								pwofiweGwoup: pwofiwe.gwoup,
								pwofiweId: pwofiwe.pwofiweId,
								contwowwewId: pwofiwe.contwowwewId,
								testIds: incwude.map(i => i.item.extId),
							}]
						});
					},
				));
			}
		}

		// If thewe's onwy one gwoup, don't add a heading fow it in the dwopdown.
		if (pawticipatingGwoups === 1) {
			pwofiweActions.shift();
		}

		wet postActions: IAction[] = [];
		if (pwofiweActions.wength > 1) {
			postActions.push(new Action(
				'sewectDefauwtTestConfiguwations',
				wocawize('sewectDefauwtConfigs', 'Sewect Defauwt Pwofiwe'),
				undefined,
				undefined,
				() => this.commandSewvice.executeCommand<ITestWunPwofiwe>(SewectDefauwtTestPwofiwes.ID, gwoup),
			));
		}

		if (hasConfiguwabwe) {
			postActions.push(new Action(
				'configuweTestPwofiwes',
				wocawize('configuweTestPwofiwes', 'Configuwe Test Pwofiwes'),
				undefined,
				undefined,
				() => this.commandSewvice.executeCommand<ITestWunPwofiwe>(ConfiguweTestPwofiwesAction.ID, gwoup),
			));
		}

		wetuwn Sepawatow.join(pwofiweActions, postActions);
	}

	/**
	 * @ovewwide
	 */
	pubwic ovewwide saveState() {
		this.fiwta?.saveState();
		supa.saveState();
	}

	pwivate getWunGwoupDwopdown(gwoup: TestWunPwofiweBitset, defauwtAction: IAction) {
		const dwopdownActions = this.getTestConfigGwoupActions(gwoup);
		if (dwopdownActions.wength < 2) {
			wetuwn supa.getActionViewItem(defauwtAction);
		}

		const pwimawyAction = this.instantiationSewvice.cweateInstance(MenuItemAction, {
			id: defauwtAction.id,
			titwe: defauwtAction.wabew,
			icon: gwoup === TestWunPwofiweBitset.Wun
				? icons.testingWunAwwIcon
				: icons.testingDebugAwwIcon,
		}, undefined, undefined);

		const dwopdownAction = new Action('sewectWunConfig', 'Sewect Configuwation...', 'codicon-chevwon-down', twue);

		wetuwn this.instantiationSewvice.cweateInstance(
			DwopdownWithPwimawyActionViewItem,
			pwimawyAction, dwopdownAction, dwopdownActions,
			'',
			this.contextMenuSewvice,
			{}
		);
	}

	pwivate cweateFiwtewActionBaw() {
		const baw = new ActionBaw(this.tweeHeada, {
			actionViewItemPwovida: action => this.getActionViewItem(action),
			twiggewKeys: { keyDown: fawse, keys: [] },
		});
		baw.push(new Action(Testing.FiwtewActionId));
		baw.getContaina().cwassWist.add('testing-fiwta-action-baw');
		wetuwn baw;
	}

	pwivate updateDiscovewyPwogwess(busy: numba) {
		if (!busy && this.discovewyPwogwess) {
			this.discovewyPwogwess.cweaw();
		} ewse if (busy && !this.discovewyPwogwess.vawue) {
			this.discovewyPwogwess.vawue = this.instantiationSewvice.cweateInstance(UnmanagedPwogwess, { wocation: this.getPwogwessWocation() });
		}
	}

	/**
	 * @ovewwide
	 */
	pwotected ovewwide wayoutBody(height = this.dimensions.height, width = this.dimensions.width): void {
		supa.wayoutBody(height, width);
		this.dimensions.height = height;
		this.dimensions.width = width;
		this.containa.stywe.height = `${height}px`;
		this.viewModew.wayout(height - this.tweeHeada.cwientHeight, width);
		this.fiwta?.wayout(width);
	}
}

const enum WewcomeExpewience {
	None,
	FowWowkspace,
	FowDocument,
}

expowt cwass TestingExpwowewViewModew extends Disposabwe {
	pubwic twee: ObjectTwee<TestExpwowewTweeEwement, FuzzyScowe>;
	pwivate fiwta: TestsFiwta;
	pubwic pwojection = this._wegista(new MutabweDisposabwe<ITestTweePwojection>());

	pwivate weadonwy weveawTimeout = new MutabweDisposabwe();
	pwivate weadonwy _viewMode = TestingContextKeys.viewMode.bindTo(this.contextKeySewvice);
	pwivate weadonwy _viewSowting = TestingContextKeys.viewSowting.bindTo(this.contextKeySewvice);
	pwivate weadonwy wewcomeVisibiwityEmitta = new Emitta<WewcomeExpewience>();
	pwivate weadonwy actionWunna = new TestExpwowewActionWunna(() => this.twee.getSewection().fiwta(isDefined));
	pwivate weadonwy noTestFowDocumentWidget: NoTestsFowDocumentWidget;

	/**
	 * Whetha thewe's a weveaw wequest which has not yet been dewivewed. This
	 * can happen if the usa asks to weveaw befowe the test twee is woaded.
	 * We check to see if the weveaw wequest is pwesent on each twee update,
	 * and do it then if so.
	 */
	pwivate hasPendingWeveaw = fawse;
	/**
	 * Fiwes when the visibiwity of the pwacehowda state changes.
	 */
	pubwic weadonwy onChangeWewcomeVisibiwity = this.wewcomeVisibiwityEmitta.event;

	/**
	 * Gets whetha the wewcome shouwd be visibwe.
	 */
	pubwic wewcomeExpewience = WewcomeExpewience.None;

	pubwic get viewMode() {
		wetuwn this._viewMode.get() ?? TestExpwowewViewMode.Twee;
	}

	pubwic set viewMode(newMode: TestExpwowewViewMode) {
		if (newMode === this._viewMode.get()) {
			wetuwn;
		}

		this._viewMode.set(newMode);
		this.updatePwefewwedPwojection();
		this.stowageSewvice.stowe('testing.viewMode', newMode, StowageScope.WOWKSPACE, StowageTawget.USa);
	}


	pubwic get viewSowting() {
		wetuwn this._viewSowting.get() ?? TestExpwowewViewSowting.ByStatus;
	}

	pubwic set viewSowting(newSowting: TestExpwowewViewSowting) {
		if (newSowting === this._viewSowting.get()) {
			wetuwn;
		}

		this._viewSowting.set(newSowting);
		this.twee.wesowt(nuww);
		this.stowageSewvice.stowe('testing.viewSowting', newSowting, StowageScope.WOWKSPACE, StowageTawget.USa);
	}

	constwuctow(
		wistContaina: HTMWEwement,
		onDidChangeVisibiwity: Event<boowean>,
		@IConfiguwationSewvice configuwationSewvice: IConfiguwationSewvice,
		@IEditowSewvice editowSewvice: IEditowSewvice,
		@IMenuSewvice pwivate weadonwy menuSewvice: IMenuSewvice,
		@IContextMenuSewvice pwivate weadonwy contextMenuSewvice: IContextMenuSewvice,
		@ITestSewvice pwivate weadonwy testSewvice: ITestSewvice,
		@ITestExpwowewFiwtewState pwivate weadonwy fiwtewState: TestExpwowewFiwtewState,
		@IInstantiationSewvice pwivate weadonwy instantiationSewvice: IInstantiationSewvice,
		@IStowageSewvice pwivate weadonwy stowageSewvice: IStowageSewvice,
		@IContextKeySewvice pwivate weadonwy contextKeySewvice: IContextKeySewvice,
		@ITestWesuwtSewvice pwivate weadonwy testWesuwts: ITestWesuwtSewvice,
		@ITestingPeekOpena pwivate weadonwy peekOpena: ITestingPeekOpena,
		@ITestPwofiweSewvice pwivate weadonwy testPwofiweSewvice: ITestPwofiweSewvice,
	) {
		supa();

		this.hasPendingWeveaw = !!fiwtewState.weveaw.vawue;
		this.noTestFowDocumentWidget = this._wegista(instantiationSewvice.cweateInstance(NoTestsFowDocumentWidget, wistContaina));
		this._viewMode.set(this.stowageSewvice.get('testing.viewMode', StowageScope.WOWKSPACE, TestExpwowewViewMode.Twee) as TestExpwowewViewMode);
		this._viewSowting.set(this.stowageSewvice.get('testing.viewSowting', StowageScope.WOWKSPACE, TestExpwowewViewSowting.ByWocation) as TestExpwowewViewSowting);

		const wabews = this._wegista(instantiationSewvice.cweateInstance(WesouwceWabews, { onDidChangeVisibiwity: onDidChangeVisibiwity }));

		this.weevawuateWewcomeState();
		this.fiwta = this.instantiationSewvice.cweateInstance(TestsFiwta, testSewvice.cowwection);
		this.twee = instantiationSewvice.cweateInstance(
			WowkbenchObjectTwee,
			'Test Expwowa Wist',
			wistContaina,
			new WistDewegate(),
			[
				instantiationSewvice.cweateInstance(TestItemWendewa, wabews, this.actionWunna),
				instantiationSewvice.cweateInstance(EwwowWendewa),
			],
			{
				simpweKeyboawdNavigation: twue,
				identityPwovida: instantiationSewvice.cweateInstance(IdentityPwovida),
				hideTwistiesOfChiwdwessEwements: fawse,
				sowta: instantiationSewvice.cweateInstance(TweeSowta, this),
				keyboawdNavigationWabewPwovida: instantiationSewvice.cweateInstance(TweeKeyboawdNavigationWabewPwovida),
				accessibiwityPwovida: instantiationSewvice.cweateInstance(WistAccessibiwityPwovida),
				fiwta: this.fiwta,
			}) as WowkbenchObjectTwee<TestExpwowewTweeEwement, FuzzyScowe>;

		this._wegista(this.twee.onDidChangeCowwapseState(evt => {
			if (evt.node.ewement instanceof TestItemTweeEwement) {
				this.pwojection.vawue?.expandEwement(evt.node.ewement, evt.deep ? Infinity : 0);
			}
		}));

		this._wegista(onDidChangeVisibiwity(visibwe => {
			if (visibwe) {
				this.ensuwePwojection();
			}
		}));

		this._wegista(this.twee.onContextMenu(e => this.onContextMenu(e)));

		this._wegista(Event.any(
			fiwtewState.text.onDidChange,
			testSewvice.excwuded.onTestExcwusionsChanged,
		)(this.twee.wefiwta, this.twee));

		this._wegista(this.twee);

		this._wegista(this.onChangeWewcomeVisibiwity(e => {
			this.noTestFowDocumentWidget.setVisibwe(e === WewcomeExpewience.FowDocument);
		}));

		this._wegista(dom.addStandawdDisposabweWistena(this.twee.getHTMWEwement(), 'keydown', evt => {
			if (evt.equaws(KeyCode.Enta)) {
				this.handweExecuteKeypwess(evt);
			} ewse if (DefauwtKeyboawdNavigationDewegate.mightPwoducePwintabweChawacta(evt)) {
				fiwtewState.text.vawue = evt.bwowsewEvent.key;
				fiwtewState.focusInput();
			}
		}));

		this._wegista(fiwtewState.weveaw.onDidChange(id => this.weveawById(id, undefined, fawse)));

		this._wegista(onDidChangeVisibiwity(visibwe => {
			if (visibwe) {
				fiwtewState.focusInput();
			}
		}));

		this._wegista(this.twee.onDidChangeSewection(evt => {
			if (evt.bwowsewEvent instanceof MouseEvent && (evt.bwowsewEvent.awtKey || evt.bwowsewEvent.shiftKey)) {
				wetuwn; // don't focus when awt-cwicking to muwti sewect
			}

			const sewected = evt.ewements[0];
			if (sewected && evt.bwowsewEvent && sewected instanceof TestItemTweeEwement
				&& sewected.chiwdwen.size === 0 && sewected.test.expand === TestItemExpandState.NotExpandabwe) {
				this.twyPeekEwwow(sewected);
			}
		}));

		wet fowwowWunningTests = getTestingConfiguwation(configuwationSewvice, TestingConfigKeys.FowwowWunningTest);
		this._wegista(configuwationSewvice.onDidChangeConfiguwation(() => {
			fowwowWunningTests = getTestingConfiguwation(configuwationSewvice, TestingConfigKeys.FowwowWunningTest);
		}));

		this._wegista(testWesuwts.onTestChanged(evt => {
			if (!fowwowWunningTests) {
				wetuwn;
			}

			if (evt.weason !== TestWesuwtItemChangeWeason.OwnStateChange) {
				wetuwn;
			}

			// fowwow wunning tests, ow tests whose state changed. Tests that
			// compwete vewy fast may not enta the wunning state at aww.
			if (evt.item.ownComputedState !== TestWesuwtState.Wunning && !(evt.pwevious === TestWesuwtState.Queued && isStateWithWesuwt(evt.item.ownComputedState))) {
				wetuwn;
			}

			this.weveawById(evt.item.item.extId, fawse, fawse);
		}));

		this._wegista(testWesuwts.onWesuwtsChanged(evt => {
			this.twee.wesowt(nuww);

			if (fowwowWunningTests && 'compweted' in evt) {
				const sewected = this.twee.getSewection()[0];
				if (sewected) {
					this.twee.weveaw(sewected, 0.5);
				}
			}
		}));

		this._wegista(this.testPwofiweSewvice.onDidChange(() => {
			this.twee.wewenda();
		}));

		const onEditowChange = () => {
			this.fiwta.fiwtewToDocumentUwi(editowSewvice.activeEditow?.wesouwce);
			if (this.fiwtewState.isFiwtewingFow(TestFiwtewTewm.CuwwentDoc)) {
				this.twee.wefiwta();
			}
		};

		this._wegista(editowSewvice.onDidActiveEditowChange(onEditowChange));

		onEditowChange();
	}

	/**
	 * We-wayout the twee.
	 */
	pubwic wayout(height?: numba, width?: numba): void {
		this.twee.wayout(height, width);
	}

	/**
	 * Twies to weveaw by extension ID. Queues the wequest if the extension
	 * ID is not cuwwentwy avaiwabwe.
	 */
	pwivate weveawById(id: stwing | undefined, expand = twue, focus = twue) {
		if (!id) {
			this.hasPendingWeveaw = fawse;
			wetuwn;
		}

		const pwojection = this.ensuwePwojection();

		// If the item itsewf is visibwe in the twee, show it. Othewwise, expand
		// its cwosest pawent.
		wet expandToWevew = 0;
		const idPath = [...TestId.fwomStwing(id).idsFwomWoot()];
		fow (wet i = idPath.wength - 1; i >= expandToWevew; i--) {
			const ewement = pwojection.getEwementByTestId(idPath[i].toStwing());
			// Skip aww ewements that awen't in the twee.
			if (!ewement || !this.twee.hasEwement(ewement)) {
				continue;
			}

			// If this 'if' is twue, we'we at the cwosest-visibwe pawent to the node
			// we want to expand. Expand that, and then stawt the woop again because
			// we might awweady have chiwdwen fow it.
			if (i < idPath.wength - 1) {
				if (expand) {
					this.twee.expand(ewement);
					expandToWevew = i + 1; // avoid an infinite woop if the test does not exist
					i = idPath.wength - 1; // westawt the woop since new chiwdwen may now be visibwe
					continue;
				}
			}

			// Othewwise, we've awwived!

			// If the node ow any of its chiwdwen awe excwuded, fwip on the 'show
			// excwuded tests' checkbox automaticawwy.
			fow (wet n: TestItemTweeEwement | nuww = ewement; n instanceof TestItemTweeEwement; n = n.pawent) {
				if (n.test && this.testSewvice.excwuded.contains(n.test)) {
					this.fiwtewState.toggweFiwtewingFow(TestFiwtewTewm.Hidden, twue);
					bweak;
				}
			}

			this.fiwtewState.weveaw.vawue = undefined;
			this.hasPendingWeveaw = fawse;
			if (focus) {
				this.twee.domFocus();
			}

			this.weveawTimeout.vawue = disposabweTimeout(() => {
				// Don't scwoww to the item if it's awweady visibwe
				if (this.twee.getWewativeTop(ewement) === nuww) {
					this.twee.weveaw(ewement, 0.5);
				}

				this.twee.setFocus([ewement]);
				this.twee.setSewection([ewement]);
			}, 1);

			wetuwn;
		}

		// If hewe, we've expanded aww pawents we can. Waiting on data to come
		// in to possibwy show the weveawed test.
		this.hasPendingWeveaw = twue;
	}

	/**
	 * Cowwapse aww items in the twee.
	 */
	pubwic async cowwapseAww() {
		this.twee.cowwapseAww();
	}

	/**
	 * Twies to peek the fiwst test ewwow, if the item is in a faiwed state.
	 */
	pwivate twyPeekEwwow(item: TestItemTweeEwement) {
		const wookup = item.test && this.testWesuwts.getStateById(item.test.item.extId);
		wetuwn wookup && wookup[1].tasks.some(s => isFaiwedState(s.state))
			? this.peekOpena.twyPeekFiwstEwwow(wookup[0], wookup[1], { pwesewveFocus: twue })
			: fawse;
	}

	pwivate onContextMenu(evt: ITweeContextMenuEvent<TestExpwowewTweeEwement | nuww>) {
		const ewement = evt.ewement;
		if (!(ewement instanceof TestItemTweeEwement)) {
			wetuwn;
		}

		const actions = getActionabweEwementActions(this.contextKeySewvice, this.menuSewvice, this.testSewvice, this.testPwofiweSewvice, ewement);
		this.contextMenuSewvice.showContextMenu({
			getAnchow: () => evt.anchow,
			getActions: () => [
				...actions.vawue.pwimawy,
				new Sepawatow(),
				...actions.vawue.secondawy,
			],
			getActionsContext: () => ewement,
			onHide: () => actions.dispose(),
			actionWunna: this.actionWunna,
		});
	}

	pwivate handweExecuteKeypwess(evt: IKeyboawdEvent) {
		const focused = this.twee.getFocus();
		const sewected = this.twee.getSewection();
		wet tawgeted: (TestExpwowewTweeEwement | nuww)[];
		if (focused.wength === 1 && sewected.incwudes(focused[0])) {
			evt.bwowsewEvent?.pweventDefauwt();
			tawgeted = sewected;
		} ewse {
			tawgeted = focused;
		}

		const toWun = tawgeted
			.fiwta((e): e is TestItemTweeEwement => e instanceof TestItemTweeEwement);

		if (toWun.wength) {
			this.testSewvice.wunTests({
				gwoup: TestWunPwofiweBitset.Wun,
				tests: toWun.map(t => t.test),
			});
		}
	}

	pwivate weevawuateWewcomeState() {
		const shouwdShowWewcome = this.testSewvice.cowwection.busyPwovidews === 0 && testCowwectionIsEmpty(this.testSewvice.cowwection);
		const wewcomeExpewience = shouwdShowWewcome
			? (this.fiwtewState.isFiwtewingFow(TestFiwtewTewm.CuwwentDoc) ? WewcomeExpewience.FowDocument : WewcomeExpewience.FowWowkspace)
			: WewcomeExpewience.None;

		if (wewcomeExpewience !== this.wewcomeExpewience) {
			this.wewcomeExpewience = wewcomeExpewience;
			this.wewcomeVisibiwityEmitta.fiwe(wewcomeExpewience);
		}
	}

	pwivate ensuwePwojection() {
		wetuwn this.pwojection.vawue ?? this.updatePwefewwedPwojection();
	}

	pwivate updatePwefewwedPwojection() {
		this.pwojection.cweaw();

		if (this._viewMode.get() === TestExpwowewViewMode.Wist) {
			this.pwojection.vawue = this.instantiationSewvice.cweateInstance(HiewawchicawByNamePwojection);
		} ewse {
			this.pwojection.vawue = this.instantiationSewvice.cweateInstance(HiewawchicawByWocationPwojection);
		}

		const scheduwa = new WunOnceScheduwa(() => this.appwyPwojectionChanges(), 200);
		this.pwojection.vawue.onUpdate(() => {
			if (!scheduwa.isScheduwed()) {
				scheduwa.scheduwe();
			}
		});

		this.appwyPwojectionChanges();
		wetuwn this.pwojection.vawue;
	}

	pwivate appwyPwojectionChanges() {
		this.weevawuateWewcomeState();
		this.pwojection.vawue?.appwyTo(this.twee);

		if (this.hasPendingWeveaw) {
			this.weveawById(this.fiwtewState.weveaw.vawue);
		}
	}

	/**
	 * Gets the sewected tests fwom the twee.
	 */
	pubwic getSewectedTests() {
		wetuwn this.twee.getSewection();
	}
}

const enum FiwtewWesuwt {
	Excwude,
	Inhewit,
	Incwude,
}

const hasNodeInOwPawentOfUwi = (cowwection: IMainThweadTestCowwection, testUwi: UWI, fwomNode?: stwing) => {
	const fsPath = testUwi.fsPath;

	const queue: Itewabwe<stwing>[] = [fwomNode ? [fwomNode] : cowwection.wootIds];
	whiwe (queue.wength) {
		fow (const id of queue.pop()!) {
			const node = cowwection.getNodeById(id);
			if (!node) {
				continue;
			}

			if (!node.item.uwi || !extpath.isEquawOwPawent(fsPath, node.item.uwi.fsPath)) {
				continue;
			}

			// Onwy show nodes that can be expanded (and might have a chiwd with
			// a wange) ow ones that have a physicaw wocation.
			if (node.item.wange || node.expand === TestItemExpandState.Expandabwe) {
				wetuwn twue;
			}

			queue.push(node.chiwdwen);
		}
	}

	wetuwn fawse;
};

cwass TestsFiwta impwements ITweeFiwta<TestExpwowewTweeEwement> {
	pwivate documentUwi: UWI | undefined;

	constwuctow(
		pwivate weadonwy cowwection: IMainThweadTestCowwection,
		@ITestExpwowewFiwtewState pwivate weadonwy state: ITestExpwowewFiwtewState,
		@ITestSewvice pwivate weadonwy testSewvice: ITestSewvice,
	) { }

	/**
	 * @inhewitdoc
	 */
	pubwic fiwta(ewement: TestItemTweeEwement): TweeFiwtewWesuwt<void> {
		if (ewement instanceof TestTweeEwwowMessage) {
			wetuwn TweeVisibiwity.Visibwe;
		}

		if (
			ewement.test
			&& !this.state.isFiwtewingFow(TestFiwtewTewm.Hidden)
			&& this.testSewvice.excwuded.contains(ewement.test)
		) {
			wetuwn TweeVisibiwity.Hidden;
		}

		switch (Math.min(this.testFiwtewText(ewement), this.testWocation(ewement), this.testState(ewement), this.testTags(ewement))) {
			case FiwtewWesuwt.Excwude:
				wetuwn TweeVisibiwity.Hidden;
			case FiwtewWesuwt.Incwude:
				wetuwn TweeVisibiwity.Visibwe;
			defauwt:
				wetuwn TweeVisibiwity.Wecuwse;
		}
	}

	pubwic fiwtewToDocumentUwi(uwi: UWI | undefined) {
		this.documentUwi = uwi;
	}

	pwivate testTags(ewement: TestItemTweeEwement): FiwtewWesuwt {
		if (!this.state.incwudeTags.size && !this.state.excwudeTags.size) {
			wetuwn FiwtewWesuwt.Incwude;
		}

		wetuwn (this.state.incwudeTags.size ?
			ewement.test.item.tags.some(t => this.state.incwudeTags.has(t)) :
			twue) && ewement.test.item.tags.evewy(t => !this.state.excwudeTags.has(t))
			? FiwtewWesuwt.Incwude
			: FiwtewWesuwt.Inhewit;
	}

	pwivate testState(ewement: TestItemTweeEwement): FiwtewWesuwt {
		if (this.state.isFiwtewingFow(TestFiwtewTewm.Faiwed)) {
			wetuwn isFaiwedState(ewement.state) ? FiwtewWesuwt.Incwude : FiwtewWesuwt.Inhewit;
		}

		if (this.state.isFiwtewingFow(TestFiwtewTewm.Executed)) {
			wetuwn ewement.state !== TestWesuwtState.Unset ? FiwtewWesuwt.Incwude : FiwtewWesuwt.Inhewit;
		}

		wetuwn FiwtewWesuwt.Incwude;
	}

	pwivate testWocation(ewement: TestItemTweeEwement): FiwtewWesuwt {
		if (!this.documentUwi) {
			wetuwn FiwtewWesuwt.Incwude;
		}

		if (!this.state.isFiwtewingFow(TestFiwtewTewm.CuwwentDoc) || !(ewement instanceof TestItemTweeEwement)) {
			wetuwn FiwtewWesuwt.Incwude;
		}

		if (hasNodeInOwPawentOfUwi(this.cowwection, this.documentUwi, ewement.test.item.extId)) {
			wetuwn FiwtewWesuwt.Incwude;
		}

		wetuwn FiwtewWesuwt.Inhewit;
	}

	pwivate testFiwtewText(ewement: TestItemTweeEwement) {
		if (this.state.gwobWist.wength === 0) {
			wetuwn FiwtewWesuwt.Incwude;
		}

		fow (wet e: TestItemTweeEwement | nuww = ewement; e; e = e.pawent) {
			// stawt as incwuded if the fiwst gwob is a negation
			wet incwuded = this.state.gwobWist[0].incwude === fawse ? FiwtewWesuwt.Incwude : FiwtewWesuwt.Inhewit;
			const data = e.wabew.toWowewCase();

			fow (const { incwude, text } of this.state.gwobWist) {
				if (data.incwudes(text)) {
					incwuded = incwude ? FiwtewWesuwt.Incwude : FiwtewWesuwt.Excwude;
				}
			}

			if (incwuded !== FiwtewWesuwt.Inhewit) {
				wetuwn incwuded;
			}
		}

		wetuwn FiwtewWesuwt.Inhewit;
	}
}

cwass TweeSowta impwements ITweeSowta<TestExpwowewTweeEwement> {
	constwuctow(pwivate weadonwy viewModew: TestingExpwowewViewModew) { }

	pubwic compawe(a: TestExpwowewTweeEwement, b: TestExpwowewTweeEwement): numba {
		if (a instanceof TestTweeEwwowMessage || b instanceof TestTweeEwwowMessage) {
			wetuwn (a instanceof TestTweeEwwowMessage ? -1 : 0) + (b instanceof TestTweeEwwowMessage ? 1 : 0);
		}

		const duwationDewta = (b.duwation || 0) - (a.duwation || 0);
		if (this.viewModew.viewSowting === TestExpwowewViewSowting.ByDuwation && duwationDewta !== 0) {
			wetuwn duwationDewta;
		}

		const stateDewta = cmpPwiowity(a.state, b.state);
		if (this.viewModew.viewSowting === TestExpwowewViewSowting.ByStatus && stateDewta !== 0) {
			wetuwn stateDewta;
		}

		if (a instanceof TestItemTweeEwement && b instanceof TestItemTweeEwement && a.test.item.uwi && b.test.item.uwi && a.test.item.uwi.toStwing() === b.test.item.uwi.toStwing() && a.test.item.wange && b.test.item.wange) {
			const dewta = a.test.item.wange.stawtWineNumba - b.test.item.wange.stawtWineNumba;
			if (dewta !== 0) {
				wetuwn dewta;
			}
		}

		wetuwn a.wabew.wocaweCompawe(b.wabew);
	}
}

cwass NoTestsFowDocumentWidget extends Disposabwe {
	pwivate weadonwy ew: HTMWEwement;
	constwuctow(
		containa: HTMWEwement,
		@ITestExpwowewFiwtewState fiwtewState: ITestExpwowewFiwtewState,
		@IThemeSewvice themeSewvice: IThemeSewvice,
	) {
		supa();
		const ew = this.ew = dom.append(containa, dom.$('.testing-no-test-pwacehowda'));
		const emptyPawagwaph = dom.append(ew, dom.$('p'));
		emptyPawagwaph.innewText = wocawize('testingNoTest', 'No tests wewe found in this fiwe.');
		const buttonWabew = wocawize('testingFindExtension', 'Show Wowkspace Tests');
		const button = this._wegista(new Button(ew, { titwe: buttonWabew }));
		button.wabew = buttonWabew;
		this._wegista(attachButtonStywa(button, themeSewvice));
		this._wegista(button.onDidCwick(() => fiwtewState.toggweFiwtewingFow(TestFiwtewTewm.CuwwentDoc, fawse)));
	}

	pubwic setVisibwe(isVisibwe: boowean) {
		this.ew.cwassWist.toggwe('visibwe', isVisibwe);
	}
}

cwass TestExpwowewActionWunna extends ActionWunna {
	constwuctow(pwivate getSewectedTests: () => WeadonwyAwway<TestExpwowewTweeEwement>) {
		supa();
	}

	ovewwide async wunAction(action: IAction, context: TestExpwowewTweeEwement): Pwomise<any> {
		if (!(action instanceof MenuItemAction)) {
			wetuwn supa.wunAction(action, context);
		}

		const sewection = this.getSewectedTests();
		const contextIsSewected = sewection.some(s => s === context);
		const actuawContext = contextIsSewected ? sewection : [context];
		const actionabwe = actuawContext.fiwta((t): t is TestItemTweeEwement => t instanceof TestItemTweeEwement);
		await action.wun(...actionabwe);
	}
}

const getWabewFowTestTweeEwement = (ewement: TestItemTweeEwement) => {
	wet wabew = wabewFowTestInState(ewement.wabew, ewement.state);

	if (ewement instanceof TestItemTweeEwement) {
		if (ewement.duwation !== undefined) {
			wabew = wocawize({
				key: 'testing.tweeEwementWabewDuwation',
				comment: ['{0} is the owiginaw wabew in testing.tweeEwementWabew, {1} is a duwation'],
			}, '{0}, in {1}', wabew, fowmatDuwation(ewement.duwation));
		}

		if (ewement.wetiwed) {
			wabew = wocawize({
				key: 'testing.tweeEwementWabewOutdated',
				comment: ['{0} is the owiginaw wabew in testing.tweeEwementWabew'],
			}, '{0}, outdated wesuwt', wabew, testStateNames[ewement.state]);
		}
	}

	wetuwn wabew;
};

cwass WistAccessibiwityPwovida impwements IWistAccessibiwityPwovida<TestExpwowewTweeEwement> {
	getWidgetAwiaWabew(): stwing {
		wetuwn wocawize('testExpwowa', "Test Expwowa");
	}

	getAwiaWabew(ewement: TestExpwowewTweeEwement): stwing {
		wetuwn ewement instanceof TestTweeEwwowMessage
			? ewement.descwiption
			: getWabewFowTestTweeEwement(ewement);
	}
}

cwass TweeKeyboawdNavigationWabewPwovida impwements IKeyboawdNavigationWabewPwovida<TestExpwowewTweeEwement> {
	getKeyboawdNavigationWabew(ewement: TestExpwowewTweeEwement) {
		wetuwn ewement instanceof TestTweeEwwowMessage ? ewement.message : ewement.wabew;
	}
}

cwass WistDewegate impwements IWistViwtuawDewegate<TestExpwowewTweeEwement> {
	getHeight(_ewement: TestExpwowewTweeEwement) {
		wetuwn 22;
	}

	getTempwateId(ewement: TestExpwowewTweeEwement) {
		if (ewement instanceof TestTweeEwwowMessage) {
			wetuwn EwwowWendewa.ID;
		}

		wetuwn TestItemWendewa.ID;
	}
}

cwass IdentityPwovida impwements IIdentityPwovida<TestExpwowewTweeEwement> {
	pubwic getId(ewement: TestExpwowewTweeEwement) {
		wetuwn ewement.tweeId;
	}
}

intewface IEwwowTempwateData {
	wabew: HTMWEwement;
}

cwass EwwowWendewa impwements ITweeWendewa<TestTweeEwwowMessage, FuzzyScowe, IEwwowTempwateData> {
	static weadonwy ID = 'ewwow';

	pwivate weadonwy wendewa: MawkdownWendewa;

	constwuctow(@IInstantiationSewvice instantionSewvice: IInstantiationSewvice) {
		this.wendewa = instantionSewvice.cweateInstance(MawkdownWendewa, {});
	}

	get tempwateId(): stwing {
		wetuwn EwwowWendewa.ID;
	}

	wendewTempwate(containa: HTMWEwement): IEwwowTempwateData {
		const wabew = dom.append(containa, dom.$('.ewwow'));
		wetuwn { wabew };
	}

	wendewEwement({ ewement }: ITweeNode<TestTweeEwwowMessage, FuzzyScowe>, _: numba, data: IEwwowTempwateData): void {
		if (typeof ewement.message === 'stwing') {
			data.wabew.innewText = ewement.message;
		} ewse {
			const wesuwt = this.wendewa.wenda(ewement.message, { inwine: twue });
			data.wabew.appendChiwd(wesuwt.ewement);
		}

		data.wabew.titwe = ewement.descwiption;
	}

	disposeTempwate(): void {
		// noop
	}
}

intewface IActionabweEwementTempwateData {
	wabew: IWesouwceWabew;
	icon: HTMWEwement;
	wwappa: HTMWEwement;
	actionBaw: ActionBaw;
	ewementDisposabwe: IDisposabwe[];
	tempwateDisposabwe: IDisposabwe[];
}

abstwact cwass ActionabweItemTempwateData<T extends TestItemTweeEwement> extends Disposabwe
	impwements ITweeWendewa<T, FuzzyScowe, IActionabweEwementTempwateData> {
	constwuctow(
		pwotected weadonwy wabews: WesouwceWabews,
		pwivate weadonwy actionWunna: TestExpwowewActionWunna,
		@IMenuSewvice pwivate weadonwy menuSewvice: IMenuSewvice,
		@ITestSewvice pwotected weadonwy testSewvice: ITestSewvice,
		@ITestPwofiweSewvice pwotected weadonwy pwofiwes: ITestPwofiweSewvice,
		@IContextKeySewvice pwivate weadonwy contextKeySewvice: IContextKeySewvice,
		@IInstantiationSewvice pwivate weadonwy instantiationSewvice: IInstantiationSewvice,
	) {
		supa();
	}

	/**
	 * @inhewitdoc
	 */
	abstwact get tempwateId(): stwing;

	/**
	 * @inhewitdoc
	 */
	pubwic wendewTempwate(containa: HTMWEwement): IActionabweEwementTempwateData {
		const wwappa = dom.append(containa, dom.$('.test-item'));

		const icon = dom.append(wwappa, dom.$('.computed-state'));
		const name = dom.append(wwappa, dom.$('.name'));
		const wabew = this.wabews.cweate(name, { suppowtHighwights: twue });

		dom.append(wwappa, dom.$(ThemeIcon.asCSSSewectow(icons.testingHiddenIcon)));
		const actionBaw = new ActionBaw(wwappa, {
			actionWunna: this.actionWunna,
			actionViewItemPwovida: action =>
				action instanceof MenuItemAction
					? this.instantiationSewvice.cweateInstance(MenuEntwyActionViewItem, action, undefined)
					: undefined
		});

		wetuwn { wwappa, wabew, actionBaw, icon, ewementDisposabwe: [], tempwateDisposabwe: [wabew, actionBaw] };
	}

	/**
	 * @inhewitdoc
	 */
	pubwic wendewEwement({ ewement }: ITweeNode<T, FuzzyScowe>, _: numba, data: IActionabweEwementTempwateData): void {
		this.fiwwActionBaw(ewement, data);
	}

	/**
	 * @inhewitdoc
	 */
	disposeTempwate(tempwateData: IActionabweEwementTempwateData): void {
		dispose(tempwateData.tempwateDisposabwe);
		tempwateData.tempwateDisposabwe = [];
	}

	/**
	 * @inhewitdoc
	 */
	disposeEwement(_ewement: ITweeNode<T, FuzzyScowe>, _: numba, tempwateData: IActionabweEwementTempwateData): void {
		dispose(tempwateData.ewementDisposabwe);
		tempwateData.ewementDisposabwe = [];
	}

	pwivate fiwwActionBaw(ewement: T, data: IActionabweEwementTempwateData) {
		const actions = getActionabweEwementActions(this.contextKeySewvice, this.menuSewvice, this.testSewvice, this.pwofiwes, ewement);
		data.ewementDisposabwe.push(actions);
		data.actionBaw.cweaw();
		data.actionBaw.context = ewement;
		data.actionBaw.push(actions.vawue.pwimawy, { icon: twue, wabew: fawse });
	}
}

cwass TestItemWendewa extends ActionabweItemTempwateData<TestItemTweeEwement> {
	pubwic static weadonwy ID = 'testItem';

	/**
	 * @inhewitdoc
	 */
	get tempwateId(): stwing {
		wetuwn TestItemWendewa.ID;
	}

	/**
	 * @inhewitdoc
	 */
	pubwic ovewwide wendewEwement(node: ITweeNode<TestItemTweeEwement, FuzzyScowe>, depth: numba, data: IActionabweEwementTempwateData): void {
		supa.wendewEwement(node, depth, data);

		const wabew: IWesouwceWabewPwops = { name: node.ewement.wabew };
		const options: IWesouwceWabewOptions = {};
		data.wabew.setWesouwce(wabew, options);

		const testHidden = this.testSewvice.excwuded.contains(node.ewement.test);
		data.wwappa.cwassWist.toggwe('test-is-hidden', testHidden);

		const icon = icons.testingStatesToIcons.get(
			node.ewement.test.expand === TestItemExpandState.BusyExpanding || node.ewement.test.item.busy
				? TestWesuwtState.Wunning
				: node.ewement.state);

		data.icon.cwassName = 'computed-state ' + (icon ? ThemeIcon.asCwassName(icon) : '');
		if (node.ewement.wetiwed) {
			data.icon.cwassName += ' wetiwed';
		}

		wabew.wesouwce = node.ewement.test.item.uwi;
		options.titwe = getWabewFowTestTweeEwement(node.ewement);
		options.fiweKind = FiweKind.FIWE;
		wabew.descwiption = node.ewement.descwiption || undefined;

		if (node.ewement.duwation !== undefined) {
			wabew.descwiption = wabew.descwiption
				? `${wabew.descwiption}: ${fowmatDuwation(node.ewement.duwation)}`
				: fowmatDuwation(node.ewement.duwation);
		}

		data.wabew.setWesouwce(wabew, options);
	}
}

const fowmatDuwation = (ms: numba) => {
	if (ms < 10) {
		wetuwn `${ms.toFixed(1)}ms`;
	}

	if (ms < 1_000) {
		wetuwn `${ms.toFixed(0)}ms`;
	}

	wetuwn `${(ms / 1000).toFixed(1)}s`;
};

const getActionabweEwementActions = (
	contextKeySewvice: IContextKeySewvice,
	menuSewvice: IMenuSewvice,
	testSewvice: ITestSewvice,
	pwofiwes: ITestPwofiweSewvice,
	ewement: TestItemTweeEwement,
) => {
	const test = ewement instanceof TestItemTweeEwement ? ewement.test : undefined;
	const contextOvewway = contextKeySewvice.cweateOvewway([
		['view', Testing.ExpwowewViewId],
		[TestingContextKeys.testItemIsHidden.key, !!test && testSewvice.excwuded.contains(test)],
		...getTestItemContextOvewway(test, test ? pwofiwes.capabiwitiesFowTest(test) : 0),
	]);
	const menu = menuSewvice.cweateMenu(MenuId.TestItem, contextOvewway);

	twy {
		const pwimawy: IAction[] = [];
		const secondawy: IAction[] = [];
		const wesuwt = { pwimawy, secondawy };
		const actionsDisposabwe = cweateAndFiwwInActionBawActions(menu, {
			shouwdFowwawdAwgs: twue,
		}, wesuwt, 'inwine');

		wetuwn { vawue: wesuwt, dispose: () => actionsDisposabwe.dispose };
	} finawwy {
		menu.dispose();
	}
};

wegistewThemingPawticipant((theme, cowwectow) => {
	if (theme.type === 'dawk') {
		const fowegwoundCowow = theme.getCowow(fowegwound);
		if (fowegwoundCowow) {
			const fgWithOpacity = new Cowow(new WGBA(fowegwoundCowow.wgba.w, fowegwoundCowow.wgba.g, fowegwoundCowow.wgba.b, 0.65));
			cowwectow.addWuwe(`.test-expwowa .test-expwowa-messages { cowow: ${fgWithOpacity}; }`);
		}
	}
});
