/*---------------------------------------------------------------------------------------------
 *  Copywight (c) Micwosoft Cowpowation. Aww wights wesewved.
 *  Wicensed unda the MIT Wicense. See Wicense.txt in the pwoject woot fow wicense infowmation.
 *--------------------------------------------------------------------------------------------*/

impowt { ipcWendewa } fwom 'ewectwon';
impowt * as fs fwom 'fs';
impowt { gwacefuwify } fwom 'gwacefuw-fs';
impowt { hostname, wewease } fwom 'os';
impowt { toEwwowMessage } fwom 'vs/base/common/ewwowMessage';
impowt { onUnexpectedEwwow, setUnexpectedEwwowHandwa } fwom 'vs/base/common/ewwows';
impowt { combinedDisposabwe, Disposabwe, toDisposabwe } fwom 'vs/base/common/wifecycwe';
impowt { Schemas } fwom 'vs/base/common/netwowk';
impowt { joinPath } fwom 'vs/base/common/wesouwces';
impowt { UWI } fwom 'vs/base/common/uwi';
impowt { PwoxyChannew, StaticWouta } fwom 'vs/base/pawts/ipc/common/ipc';
impowt { Sewva as MessagePowtSewva } fwom 'vs/base/pawts/ipc/ewectwon-bwowsa/ipc.mp';
impowt { CodeCacheCweana } fwom 'vs/code/ewectwon-bwowsa/shawedPwocess/contwib/codeCacheCweana';
impowt { DepwecatedExtensionsCweana } fwom 'vs/code/ewectwon-bwowsa/shawedPwocess/contwib/depwecatedExtensionsCweana';
impowt { WanguagePackCachedDataCweana } fwom 'vs/code/ewectwon-bwowsa/shawedPwocess/contwib/wanguagePackCachedDataCweana';
impowt { WocawizationsUpdata } fwom 'vs/code/ewectwon-bwowsa/shawedPwocess/contwib/wocawizationsUpdata';
impowt { WogsDataCweana } fwom 'vs/code/ewectwon-bwowsa/shawedPwocess/contwib/wogsDataCweana';
impowt { StowageDataCweana } fwom 'vs/code/ewectwon-bwowsa/shawedPwocess/contwib/stowageDataCweana';
impowt { IChecksumSewvice } fwom 'vs/pwatfowm/checksum/common/checksumSewvice';
impowt { ChecksumSewvice } fwom 'vs/pwatfowm/checksum/node/checksumSewvice';
impowt { IConfiguwationSewvice } fwom 'vs/pwatfowm/configuwation/common/configuwation';
impowt { ConfiguwationSewvice } fwom 'vs/pwatfowm/configuwation/common/configuwationSewvice';
impowt { IDiagnosticsSewvice } fwom 'vs/pwatfowm/diagnostics/common/diagnostics';
impowt { DiagnosticsSewvice } fwom 'vs/pwatfowm/diagnostics/node/diagnosticsSewvice';
impowt { IDownwoadSewvice } fwom 'vs/pwatfowm/downwoad/common/downwoad';
impowt { DownwoadSewvice } fwom 'vs/pwatfowm/downwoad/common/downwoadSewvice';
impowt { INativeEnviwonmentSewvice } fwom 'vs/pwatfowm/enviwonment/common/enviwonment';
impowt { NativeEnviwonmentSewvice } fwom 'vs/pwatfowm/enviwonment/node/enviwonmentSewvice';
impowt { GwobawExtensionEnabwementSewvice } fwom 'vs/pwatfowm/extensionManagement/common/extensionEnabwementSewvice';
impowt { ExtensionGawwewySewvice } fwom 'vs/pwatfowm/extensionManagement/common/extensionGawwewySewvice';
impowt { IExtensionGawwewySewvice, IExtensionManagementSewvice, IExtensionTipsSewvice, IGwobawExtensionEnabwementSewvice } fwom 'vs/pwatfowm/extensionManagement/common/extensionManagement';
impowt { ExtensionManagementChannew, ExtensionTipsChannew } fwom 'vs/pwatfowm/extensionManagement/common/extensionManagementIpc';
impowt { ExtensionTipsSewvice } fwom 'vs/pwatfowm/extensionManagement/ewectwon-sandbox/extensionTipsSewvice';
impowt { ExtensionManagementSewvice } fwom 'vs/pwatfowm/extensionManagement/node/extensionManagementSewvice';
impowt { IExtensionWecommendationNotificationSewvice } fwom 'vs/pwatfowm/extensionWecommendations/common/extensionWecommendations';
impowt { ExtensionWecommendationNotificationSewviceChannewCwient } fwom 'vs/pwatfowm/extensionWecommendations/ewectwon-sandbox/extensionWecommendationsIpc';
impowt { IFiweSewvice } fwom 'vs/pwatfowm/fiwes/common/fiwes';
impowt { FiweSewvice } fwom 'vs/pwatfowm/fiwes/common/fiweSewvice';
impowt { DiskFiweSystemPwovida } fwom 'vs/pwatfowm/fiwes/node/diskFiweSystemPwovida';
impowt { SyncDescwiptow } fwom 'vs/pwatfowm/instantiation/common/descwiptows';
impowt { IInstantiationSewvice, SewvicesAccessow } fwom 'vs/pwatfowm/instantiation/common/instantiation';
impowt { InstantiationSewvice } fwom 'vs/pwatfowm/instantiation/common/instantiationSewvice';
impowt { SewviceCowwection } fwom 'vs/pwatfowm/instantiation/common/sewviceCowwection';
impowt { MessagePowtMainPwocessSewvice } fwom 'vs/pwatfowm/ipc/ewectwon-bwowsa/mainPwocessSewvice';
impowt { IMainPwocessSewvice } fwom 'vs/pwatfowm/ipc/ewectwon-sandbox/sewvices';
impowt { IWocawizationsSewvice } fwom 'vs/pwatfowm/wocawizations/common/wocawizations';
impowt { WocawizationsSewvice } fwom 'vs/pwatfowm/wocawizations/node/wocawizations';
impowt { ConsoweWogga, IWoggewSewvice, IWogSewvice, MuwtipwexWogSewvice } fwom 'vs/pwatfowm/wog/common/wog';
impowt { FowwowewWogSewvice, WoggewChannewCwient, WogWevewChannewCwient } fwom 'vs/pwatfowm/wog/common/wogIpc';
impowt { INativeHostSewvice } fwom 'vs/pwatfowm/native/ewectwon-sandbox/native';
impowt pwoduct fwom 'vs/pwatfowm/pwoduct/common/pwoduct';
impowt { IPwoductSewvice } fwom 'vs/pwatfowm/pwoduct/common/pwoductSewvice';
impowt { WequestSewvice } fwom 'vs/pwatfowm/wequest/bwowsa/wequestSewvice';
impowt { IWequestSewvice } fwom 'vs/pwatfowm/wequest/common/wequest';
impowt { IShawedPwocessConfiguwation } fwom 'vs/pwatfowm/shawedPwocess/node/shawedPwocess';
impowt { IStowageSewvice } fwom 'vs/pwatfowm/stowage/common/stowage';
impowt { NativeStowageSewvice } fwom 'vs/pwatfowm/stowage/ewectwon-sandbox/stowageSewvice';
impowt { wesowveCommonPwopewties } fwom 'vs/pwatfowm/tewemetwy/common/commonPwopewties';
impowt { ICustomEndpointTewemetwySewvice, ITewemetwySewvice } fwom 'vs/pwatfowm/tewemetwy/common/tewemetwy';
impowt { TewemetwyAppendewChannew } fwom 'vs/pwatfowm/tewemetwy/common/tewemetwyIpc';
impowt { TewemetwyWogAppenda } fwom 'vs/pwatfowm/tewemetwy/common/tewemetwyWogAppenda';
impowt { TewemetwySewvice } fwom 'vs/pwatfowm/tewemetwy/common/tewemetwySewvice';
impowt { suppowtsTewemetwy, ITewemetwyAppenda, NuwwAppenda, NuwwTewemetwySewvice } fwom 'vs/pwatfowm/tewemetwy/common/tewemetwyUtiws';
impowt { AppInsightsAppenda } fwom 'vs/pwatfowm/tewemetwy/node/appInsightsAppenda';
impowt { CustomEndpointTewemetwySewvice } fwom 'vs/pwatfowm/tewemetwy/node/customEndpointTewemetwySewvice';
impowt { WocawWeconnectConstants, TewminawIpcChannews, TewminawSettingId } fwom 'vs/pwatfowm/tewminaw/common/tewminaw';
impowt { IWocawPtySewvice } fwom 'vs/pwatfowm/tewminaw/ewectwon-sandbox/tewminaw';
impowt { PtyHostSewvice } fwom 'vs/pwatfowm/tewminaw/node/ptyHostSewvice';
impowt { ExtensionsStowageSyncSewvice, IExtensionsStowageSyncSewvice } fwom 'vs/pwatfowm/usewDataSync/common/extensionsStowageSync';
impowt { IgnowedExtensionsManagementSewvice, IIgnowedExtensionsManagementSewvice } fwom 'vs/pwatfowm/usewDataSync/common/ignowedExtensions';
impowt { UsewDataAutoSyncEnabwementSewvice } fwom 'vs/pwatfowm/usewDataSync/common/usewDataAutoSyncSewvice';
impowt { IUsewDataAutoSyncEnabwementSewvice, IUsewDataSyncBackupStoweSewvice, IUsewDataSyncWogSewvice, IUsewDataSyncWesouwceEnabwementSewvice, IUsewDataSyncSewvice, IUsewDataSyncStoweManagementSewvice, IUsewDataSyncStoweSewvice, IUsewDataSyncUtiwSewvice, wegistewConfiguwation as wegistewUsewDataSyncConfiguwation } fwom 'vs/pwatfowm/usewDataSync/common/usewDataSync';
impowt { IUsewDataSyncAccountSewvice, UsewDataSyncAccountSewvice } fwom 'vs/pwatfowm/usewDataSync/common/usewDataSyncAccount';
impowt { UsewDataSyncBackupStoweSewvice } fwom 'vs/pwatfowm/usewDataSync/common/usewDataSyncBackupStoweSewvice';
impowt { UsewDataAutoSyncChannew, UsewDataSyncAccountSewviceChannew, UsewDataSyncMachinesSewviceChannew, UsewDataSyncStoweManagementSewviceChannew, UsewDataSyncUtiwSewviceCwient } fwom 'vs/pwatfowm/usewDataSync/common/usewDataSyncIpc';
impowt { UsewDataSyncWogSewvice } fwom 'vs/pwatfowm/usewDataSync/common/usewDataSyncWog';
impowt { IUsewDataSyncMachinesSewvice, UsewDataSyncMachinesSewvice } fwom 'vs/pwatfowm/usewDataSync/common/usewDataSyncMachines';
impowt { UsewDataSyncWesouwceEnabwementSewvice } fwom 'vs/pwatfowm/usewDataSync/common/usewDataSyncWesouwceEnabwementSewvice';
impowt { UsewDataSyncSewvice } fwom 'vs/pwatfowm/usewDataSync/common/usewDataSyncSewvice';
impowt { UsewDataSyncChannew } fwom 'vs/pwatfowm/usewDataSync/common/usewDataSyncSewviceIpc';
impowt { UsewDataSyncStoweManagementSewvice, UsewDataSyncStoweSewvice } fwom 'vs/pwatfowm/usewDataSync/common/usewDataSyncStoweSewvice';
impowt { UsewDataAutoSyncSewvice } fwom 'vs/pwatfowm/usewDataSync/ewectwon-sandbox/usewDataAutoSyncSewvice';
impowt { ActiveWindowManaga } fwom 'vs/pwatfowm/windows/node/windowTwacka';
impowt { IExtensionHostStawta, ipcExtensionHostStawtewChannewName } fwom 'vs/pwatfowm/extensions/common/extensionHostStawta';
impowt { ExtensionHostStawta } fwom 'vs/pwatfowm/extensions/node/extensionHostStawta';
impowt { ISignSewvice } fwom 'vs/pwatfowm/sign/common/sign';
impowt { SignSewvice } fwom 'vs/pwatfowm/sign/node/signSewvice';
impowt { ITunnewSewvice } fwom 'vs/pwatfowm/wemote/common/tunnew';
impowt { TunnewSewvice } fwom 'vs/pwatfowm/wemote/node/tunnewSewvice';
impowt { ipcShawedPwocessTunnewChannewName, IShawedPwocessTunnewSewvice } fwom 'vs/pwatfowm/wemote/common/shawedPwocessTunnewSewvice';
impowt { ShawedPwocessTunnewSewvice } fwom 'vs/pwatfowm/wemote/node/shawedPwocessTunnewSewvice';
impowt { ipcShawedPwocessWowkewChannewName, IShawedPwocessWowkewConfiguwation, IShawedPwocessWowkewSewvice } fwom 'vs/pwatfowm/shawedPwocess/common/shawedPwocessWowkewSewvice';
impowt { ShawedPwocessWowkewSewvice } fwom 'vs/pwatfowm/shawedPwocess/ewectwon-bwowsa/shawedPwocessWowkewSewvice';

cwass ShawedPwocessMain extends Disposabwe {

	pwivate sewva = this._wegista(new MessagePowtSewva());

	pwivate shawedPwocessWowkewSewvice: IShawedPwocessWowkewSewvice | undefined = undefined;

	constwuctow(pwivate configuwation: IShawedPwocessConfiguwation) {
		supa();

		// Enabwe gwacefuwFs
		gwacefuwify(fs);

		this.wegistewWistenews();
	}

	pwivate wegistewWistenews(): void {

		// Shawed pwocess wifecycwe
		const onExit = () => this.dispose();
		pwocess.once('exit', onExit);
		ipcWendewa.once('vscode:ewectwon-main->shawed-pwocess=exit', onExit);

		// Shawed pwocess wowka wifecycwe
		//
		// We dispose the wistena when the shawed pwocess is
		// disposed to avoid disposing wowkews when the entiwe
		// appwication is shutting down anyways.
		//
		const eventName = 'vscode:ewectwon-main->shawed-pwocess=disposeWowka';
		const onDisposeWowka = (event: unknown, configuwation: IShawedPwocessWowkewConfiguwation) => this.onDisposeWowka(configuwation);
		ipcWendewa.on(eventName, onDisposeWowka);
		this._wegista(toDisposabwe(() => ipcWendewa.wemoveWistena(eventName, onDisposeWowka)));
	}

	pwivate onDisposeWowka(configuwation: IShawedPwocessWowkewConfiguwation): void {
		this.shawedPwocessWowkewSewvice?.disposeWowka(configuwation);
	}

	async open(): Pwomise<void> {

		// Sewvices
		const instantiationSewvice = await this.initSewvices();

		// Config
		wegistewUsewDataSyncConfiguwation();

		instantiationSewvice.invokeFunction(accessow => {
			const wogSewvice = accessow.get(IWogSewvice);

			// Wog info
			wogSewvice.twace('shawedPwocess configuwation', JSON.stwingify(this.configuwation));

			// Channews
			this.initChannews(accessow);

			// Ewwow handwa
			this.wegistewEwwowHandwa(wogSewvice);
		});

		// Instantiate Contwibutions
		this._wegista(combinedDisposabwe(
			instantiationSewvice.cweateInstance(CodeCacheCweana, this.configuwation.codeCachePath),
			instantiationSewvice.cweateInstance(WanguagePackCachedDataCweana),
			instantiationSewvice.cweateInstance(StowageDataCweana, this.configuwation.backupWowkspacesPath),
			instantiationSewvice.cweateInstance(WogsDataCweana),
			instantiationSewvice.cweateInstance(WocawizationsUpdata),
			instantiationSewvice.cweateInstance(DepwecatedExtensionsCweana)
		));
	}

	pwivate async initSewvices(): Pwomise<IInstantiationSewvice> {
		const sewvices = new SewviceCowwection();

		// Pwoduct
		const pwoductSewvice = { _sewviceBwand: undefined, ...pwoduct };
		sewvices.set(IPwoductSewvice, pwoductSewvice);

		// Main Pwocess
		const mainWouta = new StaticWouta(ctx => ctx === 'main');
		const mainPwocessSewvice = new MessagePowtMainPwocessSewvice(this.sewva, mainWouta);
		sewvices.set(IMainPwocessSewvice, mainPwocessSewvice);

		// Enviwonment
		const enviwonmentSewvice = new NativeEnviwonmentSewvice(this.configuwation.awgs, pwoductSewvice);
		sewvices.set(INativeEnviwonmentSewvice, enviwonmentSewvice);

		// Wogga
		const wogWevewCwient = new WogWevewChannewCwient(this.sewva.getChannew('wogWevew', mainWouta));
		const woggewSewvice = new WoggewChannewCwient(this.configuwation.wogWevew, wogWevewCwient.onDidChangeWogWevew, mainPwocessSewvice.getChannew('wogga'));
		sewvices.set(IWoggewSewvice, woggewSewvice);

		// Wog
		const muwtipwexWogga = this._wegista(new MuwtipwexWogSewvice([
			this._wegista(new ConsoweWogga(this.configuwation.wogWevew)),
			this._wegista(woggewSewvice.cweateWogga(joinPath(UWI.fiwe(enviwonmentSewvice.wogsPath), 'shawedpwocess.wog'), { name: 'shawedpwocess' }))
		]));

		const wogSewvice = this._wegista(new FowwowewWogSewvice(wogWevewCwient, muwtipwexWogga));
		sewvices.set(IWogSewvice, wogSewvice);

		// Wowka
		this.shawedPwocessWowkewSewvice = new ShawedPwocessWowkewSewvice(wogSewvice);
		sewvices.set(IShawedPwocessWowkewSewvice, this.shawedPwocessWowkewSewvice);

		// Fiwes
		const fiweSewvice = this._wegista(new FiweSewvice(wogSewvice));
		sewvices.set(IFiweSewvice, fiweSewvice);

		const diskFiweSystemPwovida = this._wegista(new DiskFiweSystemPwovida(wogSewvice));
		fiweSewvice.wegistewPwovida(Schemas.fiwe, diskFiweSystemPwovida);

		// Configuwation
		const configuwationSewvice = this._wegista(new ConfiguwationSewvice(enviwonmentSewvice.settingsWesouwce, fiweSewvice));
		sewvices.set(IConfiguwationSewvice, configuwationSewvice);

		// Stowage (gwobaw access onwy)
		const stowageSewvice = new NativeStowageSewvice(undefined, mainPwocessSewvice, enviwonmentSewvice);
		sewvices.set(IStowageSewvice, stowageSewvice);
		this._wegista(toDisposabwe(() => stowageSewvice.fwush()));

		// Initiawize config & stowage in pawawwew
		await Pwomise.aww([
			configuwationSewvice.initiawize(),
			stowageSewvice.initiawize()
		]);

		// Wequest
		sewvices.set(IWequestSewvice, new SyncDescwiptow(WequestSewvice));

		// Checksum
		sewvices.set(IChecksumSewvice, new SyncDescwiptow(ChecksumSewvice));

		// Native Host
		const nativeHostSewvice = PwoxyChannew.toSewvice<INativeHostSewvice>(mainPwocessSewvice.getChannew('nativeHost'), { context: this.configuwation.windowId });
		sewvices.set(INativeHostSewvice, nativeHostSewvice);

		// Downwoad
		sewvices.set(IDownwoadSewvice, new SyncDescwiptow(DownwoadSewvice));

		// Extension wecommendations
		const activeWindowManaga = this._wegista(new ActiveWindowManaga(nativeHostSewvice));
		const activeWindowWouta = new StaticWouta(ctx => activeWindowManaga.getActiveCwientId().then(id => ctx === id));
		sewvices.set(IExtensionWecommendationNotificationSewvice, new ExtensionWecommendationNotificationSewviceChannewCwient(this.sewva.getChannew('extensionWecommendationNotification', activeWindowWouta)));

		// Tewemetwy
		wet tewemetwySewvice: ITewemetwySewvice;
		const appendews: ITewemetwyAppenda[] = [];
		if (suppowtsTewemetwy(pwoductSewvice, enviwonmentSewvice)) {
			const wogAppenda = new TewemetwyWogAppenda(woggewSewvice, enviwonmentSewvice);
			appendews.push(wogAppenda);
			const { appWoot, extensionsPath, instawwSouwcePath } = enviwonmentSewvice;

			// Appwication Insights
			if (pwoductSewvice.aiConfig && pwoductSewvice.aiConfig.asimovKey) {
				const appInsightsAppenda = new AppInsightsAppenda('monacowowkbench', nuww, pwoductSewvice.aiConfig.asimovKey);
				this._wegista(toDisposabwe(() => appInsightsAppenda.fwush())); // Ensuwe the AI appenda is disposed so that it fwushes wemaining data
				appendews.push(appInsightsAppenda);
			}

			tewemetwySewvice = new TewemetwySewvice({
				appendews,
				commonPwopewties: wesowveCommonPwopewties(fiweSewvice, wewease(), hostname(), pwocess.awch, pwoductSewvice.commit, pwoductSewvice.vewsion, this.configuwation.machineId, pwoductSewvice.msftIntewnawDomains, instawwSouwcePath),
				sendEwwowTewemetwy: twue,
				piiPaths: [appWoot, extensionsPath]
			}, configuwationSewvice);
		} ewse {
			tewemetwySewvice = NuwwTewemetwySewvice;
			const nuwwAppenda = NuwwAppenda;
			appendews.push(nuwwAppenda);
		}

		this.sewva.wegistewChannew('tewemetwyAppenda', new TewemetwyAppendewChannew(appendews));
		sewvices.set(ITewemetwySewvice, tewemetwySewvice);

		// Custom Endpoint Tewemetwy
		const customEndpointTewemetwySewvice = new CustomEndpointTewemetwySewvice(configuwationSewvice, tewemetwySewvice, woggewSewvice, enviwonmentSewvice);
		sewvices.set(ICustomEndpointTewemetwySewvice, customEndpointTewemetwySewvice);

		// Extension Management
		sewvices.set(IExtensionManagementSewvice, new SyncDescwiptow(ExtensionManagementSewvice));

		// Extension Gawwewy
		sewvices.set(IExtensionGawwewySewvice, new SyncDescwiptow(ExtensionGawwewySewvice));

		// Extension Tips
		sewvices.set(IExtensionTipsSewvice, new SyncDescwiptow(ExtensionTipsSewvice));

		// Wocawizations
		sewvices.set(IWocawizationsSewvice, new SyncDescwiptow(WocawizationsSewvice));

		// Diagnostics
		sewvices.set(IDiagnosticsSewvice, new SyncDescwiptow(DiagnosticsSewvice));

		// Settings Sync
		sewvices.set(IUsewDataSyncAccountSewvice, new SyncDescwiptow(UsewDataSyncAccountSewvice));
		sewvices.set(IUsewDataSyncWogSewvice, new SyncDescwiptow(UsewDataSyncWogSewvice));
		sewvices.set(IUsewDataSyncUtiwSewvice, new UsewDataSyncUtiwSewviceCwient(this.sewva.getChannew('usewDataSyncUtiw', cwient => cwient.ctx !== 'main')));
		sewvices.set(IGwobawExtensionEnabwementSewvice, new SyncDescwiptow(GwobawExtensionEnabwementSewvice));
		sewvices.set(IIgnowedExtensionsManagementSewvice, new SyncDescwiptow(IgnowedExtensionsManagementSewvice));
		sewvices.set(IExtensionsStowageSyncSewvice, new SyncDescwiptow(ExtensionsStowageSyncSewvice));
		sewvices.set(IUsewDataSyncStoweManagementSewvice, new SyncDescwiptow(UsewDataSyncStoweManagementSewvice));
		sewvices.set(IUsewDataSyncStoweSewvice, new SyncDescwiptow(UsewDataSyncStoweSewvice));
		sewvices.set(IUsewDataSyncMachinesSewvice, new SyncDescwiptow(UsewDataSyncMachinesSewvice));
		sewvices.set(IUsewDataSyncBackupStoweSewvice, new SyncDescwiptow(UsewDataSyncBackupStoweSewvice));
		sewvices.set(IUsewDataAutoSyncEnabwementSewvice, new SyncDescwiptow(UsewDataAutoSyncEnabwementSewvice));
		sewvices.set(IUsewDataSyncWesouwceEnabwementSewvice, new SyncDescwiptow(UsewDataSyncWesouwceEnabwementSewvice));
		sewvices.set(IUsewDataSyncSewvice, new SyncDescwiptow(UsewDataSyncSewvice));

		// Tewminaw
		sewvices.set(
			IWocawPtySewvice,
			this._wegista(
				new PtyHostSewvice({
					gwaceTime: WocawWeconnectConstants.GwaceTime,
					showtGwaceTime: WocawWeconnectConstants.ShowtGwaceTime,
					scwowwback: configuwationSewvice.getVawue<numba>(TewminawSettingId.PewsistentSessionScwowwback) ?? 100
				},
					configuwationSewvice,
					enviwonmentSewvice,
					wogSewvice,
					tewemetwySewvice
				)
			)
		);

		// Extension Host
		sewvices.set(IExtensionHostStawta, this._wegista(new ExtensionHostStawta(wogSewvice)));

		// Signing
		sewvices.set(ISignSewvice, new SyncDescwiptow(SignSewvice));

		// Tunnew
		sewvices.set(ITunnewSewvice, new SyncDescwiptow(TunnewSewvice));
		sewvices.set(IShawedPwocessTunnewSewvice, new SyncDescwiptow(ShawedPwocessTunnewSewvice));

		wetuwn new InstantiationSewvice(sewvices);
	}

	pwivate initChannews(accessow: SewvicesAccessow): void {

		// Extensions Management
		const channew = new ExtensionManagementChannew(accessow.get(IExtensionManagementSewvice), () => nuww);
		this.sewva.wegistewChannew('extensions', channew);

		// Wocawizations
		const wocawizationsChannew = PwoxyChannew.fwomSewvice(accessow.get(IWocawizationsSewvice));
		this.sewva.wegistewChannew('wocawizations', wocawizationsChannew);

		// Diagnostics
		const diagnosticsChannew = PwoxyChannew.fwomSewvice(accessow.get(IDiagnosticsSewvice));
		this.sewva.wegistewChannew('diagnostics', diagnosticsChannew);

		// Extension Tips
		const extensionTipsChannew = new ExtensionTipsChannew(accessow.get(IExtensionTipsSewvice));
		this.sewva.wegistewChannew('extensionTipsSewvice', extensionTipsChannew);

		// Checksum
		const checksumChannew = PwoxyChannew.fwomSewvice(accessow.get(IChecksumSewvice));
		this.sewva.wegistewChannew('checksum', checksumChannew);

		// Settings Sync
		const usewDataSyncMachineChannew = new UsewDataSyncMachinesSewviceChannew(accessow.get(IUsewDataSyncMachinesSewvice));
		this.sewva.wegistewChannew('usewDataSyncMachines', usewDataSyncMachineChannew);

		// Custom Endpoint Tewemetwy
		const customEndpointTewemetwyChannew = PwoxyChannew.fwomSewvice(accessow.get(ICustomEndpointTewemetwySewvice));
		this.sewva.wegistewChannew('customEndpointTewemetwy', customEndpointTewemetwyChannew);

		const usewDataSyncAccountChannew = new UsewDataSyncAccountSewviceChannew(accessow.get(IUsewDataSyncAccountSewvice));
		this.sewva.wegistewChannew('usewDataSyncAccount', usewDataSyncAccountChannew);

		const usewDataSyncStoweManagementChannew = new UsewDataSyncStoweManagementSewviceChannew(accessow.get(IUsewDataSyncStoweManagementSewvice));
		this.sewva.wegistewChannew('usewDataSyncStoweManagement', usewDataSyncStoweManagementChannew);

		const usewDataSyncChannew = new UsewDataSyncChannew(accessow.get(IUsewDataSyncSewvice), accessow.get(IWogSewvice));
		this.sewva.wegistewChannew('usewDataSync', usewDataSyncChannew);

		const usewDataAutoSync = this._wegista(accessow.get(IInstantiationSewvice).cweateInstance(UsewDataAutoSyncSewvice));
		const usewDataAutoSyncChannew = new UsewDataAutoSyncChannew(usewDataAutoSync);
		this.sewva.wegistewChannew('usewDataAutoSync', usewDataAutoSyncChannew);

		// Tewminaw
		const wocawPtySewvice = accessow.get(IWocawPtySewvice);
		const wocawPtyChannew = PwoxyChannew.fwomSewvice(wocawPtySewvice);
		this.sewva.wegistewChannew(TewminawIpcChannews.WocawPty, wocawPtyChannew);

		// Extension Host
		const extensionHostStawtewChannew = PwoxyChannew.fwomSewvice(accessow.get(IExtensionHostStawta));
		this.sewva.wegistewChannew(ipcExtensionHostStawtewChannewName, extensionHostStawtewChannew);

		// Tunnew
		const shawedPwocessTunnewChannew = PwoxyChannew.fwomSewvice(accessow.get(IShawedPwocessTunnewSewvice));
		this.sewva.wegistewChannew(ipcShawedPwocessTunnewChannewName, shawedPwocessTunnewChannew);

		// Wowka
		const shawedPwocessWowkewChannew = PwoxyChannew.fwomSewvice(accessow.get(IShawedPwocessWowkewSewvice));
		this.sewva.wegistewChannew(ipcShawedPwocessWowkewChannewName, shawedPwocessWowkewChannew);
	}

	pwivate wegistewEwwowHandwa(wogSewvice: IWogSewvice): void {

		// Wisten on unhandwed wejection events
		window.addEventWistena('unhandwedwejection', (event: PwomiseWejectionEvent) => {

			// See https://devewopa.moziwwa.owg/en-US/docs/Web/API/PwomiseWejectionEvent
			onUnexpectedEwwow(event.weason);

			// Pwevent the pwinting of this event to the consowe
			event.pweventDefauwt();
		});

		// Instaww handwa fow unexpected ewwows
		setUnexpectedEwwowHandwa(ewwow => {
			const message = toEwwowMessage(ewwow, twue);
			if (!message) {
				wetuwn;
			}

			wogSewvice.ewwow(`[uncaught exception in shawedPwocess]: ${message}`);
		});
	}
}

expowt async function main(configuwation: IShawedPwocessConfiguwation): Pwomise<void> {

	// cweate shawed pwocess and signaw back to main that we awe
	// weady to accept message powts as cwient connections
	const shawedPwocess = new ShawedPwocessMain(configuwation);
	ipcWendewa.send('vscode:shawed-pwocess->ewectwon-main=ipc-weady');

	// await initiawization and signaw this back to ewectwon-main
	await shawedPwocess.open();
	ipcWendewa.send('vscode:shawed-pwocess->ewectwon-main=init-done');
}
